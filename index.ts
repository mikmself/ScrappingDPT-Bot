const puppeteer = require('puppeteer');
const puppeteerExtra = require('puppeteer-extra');
const StealthPlugin = require('puppeteer-extra-plugin-stealth');
const jsdom = require("jsdom");
const mysql = require("mysql");
const { JSDOM } = jsdom;

const proxyUrls = [
  '166.88.235.106:6415',
  '166.88.64.215:6137',
  '136.0.207.15:5964',
  '142.111.255.67:5960',
  '23.229.110.4:8532',
  '103.76.188.33:4153',
  '203.217.169.207:4153',
  '180.183.121.6:5678',
  '61.7.138.214:4145',
  '203.13.32.218:80',
  '46.227.39.2:1088',
  '202.6.233.59:7878',
  '112.194.91.239:57114',
  '82.115.21.188:1080',
  '104.168.87.16:1080',
  '152.70.246.185:31898',
  '112.195.39.128:24388',
  '91.247.92.63:5678',
  '103.245.205.142:35158',
  '103.140.88.250:5678',
  '45.70.206.42:4145',
  '203.24.109.109:80',
  '91.106.75.138:80',
  '79.9.90.134:1080',
  '45.116.114.29:5678',
  '173.249.15.248:33471',
  '177.46.198.115:8080',
  '212.5.143.42:3366',
  '46.161.196.174:4145',
  '34.102.179.21:80',
  '77.235.28.229:4153',
  '182.253.159.142:1080',
  '114.99.7.106:8004',
  '186.251.255.177:31337',
  '176.126.136.74:5678',
  '80.80.152.123:5678',
  '1.0.0.13:80',
  '104.16.207.86:80',
  '140.250.148.19:1080',
  '201.184.63.218:8080',
  '177.125.161.38:4145',
  '62.171.153.119:22273',
  '157.185.170.32:26589',
  '171.241.47.172:4007',
  '103.59.190.2:58678',
  '183.89.50.62:4145',
  '128.199.59.76:29321',
  '94.130.184.102:10015',
  '203.30.191.92:80',
  '110.185.102.103:51800',
  '113.109.29.98:3629',
  '103.47.95.81:1080',
  '45.77.4.241:9050',
  '201.236.248.250:5678',
  '42.194.203.23:1080',
  '27.151.29.27:2080',
  '162.216.204.146:1080',
  '157.245.82.62:59347',
  '195.154.49.91:10423',
  '109.73.181.133:4145',
  '51.15.190.163:14522',
  '172.105.251.72:4003',
  '180.210.222.209:1080',
  '194.31.55.41:80',
  '50.62.57.97:43879',
  '131.221.64.152:2350',
  '177.125.204.78:4145',
  '182.253.172.65:4153',
  '203.24.108.179:80',
  '141.11.182.4:3211',
  '192.12.113.226:4145',
  '103.70.159.146:5678',
  '138.201.139.223:30113',
  '140.83.52.96:41379',
  '190.113.12.75:3389',
  '111.53.178.249:7302',
  '177.222.146.125:5678',
  '142.93.109.23:58334',
  '85.116.120.106:3629',
  '201.20.79.18:5678',
  '202.159.60.65:443',
  '103.214.112.238:32323',
  '107.181.161.133:11987',
  '80.53.84.14:8080',
  '180.122.147.184:1080',
  '193.106.73.102:41883',
  '192.241.249.237:41745',
  '104.16.25.216:80',
  '185.132.126.37:3128',
  '114.29.212.145:80',
  '197.234.13.52:36902',
  '38.127.172.186:174',
  '173.249.2.186:45708',
  '167.86.67.134:23235',
  '2.137.22.252:4153',
  '165.225.204.117:10605',
  '185.161.186.82:54321',
  '41.206.58.150:5678',
  '31.172.66.166:20557',
  '116.58.254.88:4145',
  '110.77.171.70:8080',
  '116.58.239.205:4145',
  '104.200.20.136:35434',
  '185.32.47.105:4153',
  '181.193.213.130:999',
  '171.104.143.56:33080',
  '43.153.3.241:443',
  '24.78.155.155:9090',
  '203.176.141.166:4145',
  '161.35.179.193:59761',
  '45.196.150.167:5432',
  '142.93.52.63:8080',
  '46.167.238.54:5678',
  '168.205.218.26:4145',
  '181.129.186.130:5678',
  '103.60.138.33:4153',
  '45.251.231.213:59362',
  '185.162.230.201:80',
  '200.149.32.34:5678',
  '213.136.69.153:63791',
  '110.78.149.139:4145',
  '45.77.99.122:20473',
  '43.153.81.208:443',
  '43.153.29.34:443',
  '193.105.124.46:1080',
  '190.109.72.17:33633',
  '110.81.64.45:21212',
  '104.16.105.142:80',
  '110.93.231.73:5678',
  '182.253.159.115:5678',
  '213.32.91.205:3128',
  '211.174.105.18:4153',
  '104.19.225.70:80',
  '183.89.176.124:4153',
  '160.16.125.237:3030',
  '43.157.8.159:443',
  '51.210.240.92:19144',
  '86.57.134.64:41890',
  '103.119.229.130:80',
  '192.248.169.126:11034',
  '186.126.77.200:1080',
  '200.116.198.164:35683',
  '207.180.198.90:16791',
  '51.68.125.26:7497',
  '151.247.228.221:4153',
  '171.234.64.234:80',
  '104.16.213.202:80',
  '191.253.106.140:8080',
  '82.115.18.179:1080',
  '159.203.105.85:7497',
  '212.186.128.58:5678',
  '50.251.146.121:5678',
  '185.162.142.81:53281',
  '69.163.163.6:37884',
  '43.153.11.102:443',
  '182.92.127.180:3129',
  '103.199.97.161:45804',
  '46.126.70.47:9050',
  '168.227.158.49:4145',
  '128.14.226.130:60080',
  '95.142.40.99:42140',
  '174.75.211.221:4145',
  '177.12.176.250:4153',
  '190.145.132.250:4145',
  '161.97.104.4:8080',
  '38.127.179.236:2093',
  '121.13.229.213:61401',
  '178.212.51.79:5678',
  '54.39.46.86:3128',
  '91.90.114.237:1080',
  '159.192.91.134:5678',
  '185.83.186.30:4145',
  '65.20.99.43:10976',
  '104.16.108.234:80',
  '154.197.128.161:3128',
  '193.56.118.1:1080',
  '202.159.35.25:443',
  '180.183.140.141:8080',
  '113.160.58.230:4145',
  '170.233.176.128:4145',
  '104.197.84.43:80',
  '158.140.160.86:10808',
  '203.99.116.100:5678',
  '106.75.174.172:999',
  '46.21.240.185:1080',
  '65.108.57.128:10001',
  '178.72.192.37:5678',
  '182.253.247.245:4153',
  '188.94.225.13:8080',
  '79.121.31.86:5678',
  '193.84.184.25:5678',
  '79.141.160.83:15160',
  '177.223.224.17:4153',
  '177.38.5.234:4153',
  '180.183.215.154:4153',
  '45.140.88.217:26419',
  '103.12.246.53:4145',
  '104.207.144.254:8118',
  '110.77.159.12:4145',
  '101.51.105.155:4145',
  '178.62.202.227:7497',
  '177.23.184.166:52935',
  '203.34.28.166:80',
  '78.90.252.7:4153',
  '103.214.156.17:5678',
  '51.89.45.60:44469',
  '14.207.206.223:8080',
  '203.30.190.57:80',
  '46.19.141.98:9050',
  '103.12.246.109:4145',
  '45.77.111.135:15082',
  '190.111.246.128:80',
  '189.10.103.98:3128',
  '100.1.140.55:8080',
  '209.97.160.204:14061',
  '1.0.0.4:80',
  '198.37.103.71:62220',
  '122.70.153.17:24138',
  '109.86.219.179:55489',
  '206.42.40.0:5678',
  '149.20.253.40:12551',
  '2.81.216.239:4153',
  '147.139.133.15:61524',
  '202.164.194.41:4145',
  '123.155.48.196:1080',
  '104.19.120.84:80',
  '114.99.14.184:8004',
  '193.107.169.222:5678',
  '185.132.230.205:5678',
  '177.184.67.81:4145',
  '51.81.122.151:62611',
  '201.11.38.204:8081',
  '103.74.227.130:56417',
  '177.38.5.16:4153',
  '193.29.63.45:57299',
  '180.210.222.221:1080',
  '197.234.13.55:4145',
  '51.68.87.157:49320',
  '104.22.37.236:80',
  '45.174.248.1:999',
  '1.0.0.187:80',
  '58.35.208.107:4812',
  '172.65.165.93:30000',
  '193.169.81.91:5678',
  '172.247.149.170:53110',
  '202.92.5.126:44879',
  '185.236.46.221:5678',
  '37.152.163.95:4153',
  '198.11.179.15:8080',
  '110.243.2.186:9999',
  '5.39.19.152:46529',
  '45.172.108.53:9991',
  '190.85.158.46:3629',
  '103.10.99.110:5678',
  '192.12.112.65:4145',
  '185.6.104.150:5678',
  '45.115.115.145:31141',
  '194.87.58.16:80',
  '80.85.98.110:5678',
  '128.65.182.103:5678',
  '62.244.227.66:4153',
  '162.255.110.52:5678',
  '47.254.241.21:21491',
  '116.58.227.73:4145',
  '2.56.58.67:3389',
  '113.86.204.187:44844',
  '202.92.4.113:35528',
  '8.210.154.47:53367',
  '186.251.255.213:31337',
  '195.225.49.134:55774',
  '172.98.169.213:45395',
  '175.201.245.187:808',
  '104.17.166.210:80',
  '206.189.200.62:13110',
  '2.135.223.134:5678',
  '46.227.37.37:1088',
  '172.104.251.179:80',
  '122.202.3.137:5678',
  '143.137.99.202:5678',
  '94.181.174.77:4153',
  '37.98.218.137:5678',
  '185.162.228.128:80',
  '43.246.143.250:9999',
  '125.46.179.58:44844',
  '203.22.223.47:80',
  '117.10.124.11:1080',
  '104.16.106.154:80',
  '103.59.200.26:4145',
  '139.180.223.81:26171',
  '81.150.169.217:5678',
  '172.67.150.173:80',
  '103.59.203.201:4145',
  '31.170.19.233:4153',
  '27.184.136.182:21212',
  '80.54.62.254:5678',
  '143.95.103.43:60088',
  '49.51.74.61:21127',
  '202.124.43.250:4145',
  '125.26.22.7:5678',
  '45.70.206.33:4145',
  '121.205.69.23:21212',
  '103.79.96.177:4153',
  '103.47.93.25:1080',
  '41.193.226.57:5678',
  '5.9.154.177:30000',
  '82.194.133.209:4153',
  '27.156.192.8:4134',
  '139.255.45.67:5678',
  '221.217.84.154:23456',
  '198.199.122.10:3128',
  '194.31.64.197:5004',
  '43.157.51.43:443',
  '104.20.225.218:80',
  '185.237.10.250:20213',
  '146.56.150.146:32241',
  '168.195.50.225:4153',
  '89.132.207.82:4145',
  '95.65.51.8:5678',
  '197.234.13.44:4145',
  '37.187.144.55:9050',
  '103.9.188.138:52269',
  '125.26.4.197:4145',
  '177.93.76.26:4153',
  '123.145.4.15:53309',
  '45.125.222.97:47239',
  '110.136.167.118:8080',
  '113.161.248.125:1080',
  '185.220.87.150:20537',
  '185.138.230.68:5678',
  '109.92.133.194:5678',
  '185.94.6.178:4145',
  '217.115.115.148:56792',
  '202.124.43.249:4145',
  '202.165.46.14:5678',
  '113.204.4.142:10800',
  '47.101.202.178:7891',
  '45.7.210.200:4153',
  '1.20.207.225:4153',
  '83.142.126.147:80',
  '121.40.185.42:1080',
  '181.88.73.214:5678',
  '61.7.184.216:4153',
  '149.202.27.17:16379',
  '49.0.42.114:10801',
  '104.238.205.68:4003',
  '27.147.193.190:1080',
  '51.83.230.121:3128',
  '202.4.107.69:5678',
  '213.165.160.251:5678',
  '119.42.86.124:4145',
  '61.7.138.170:5678',
  '103.70.159.142:5678',
  '36.91.190.61:5678',
  '118.173.197.241:4145',
  '103.47.93.243:1080',
  '178.154.228.16:9050',
  '68.183.128.131:8080',
  '185.171.54.34:4153',
  '213.149.156.87:5678',
  '77.46.138.37:33608',
  '185.169.181.18:34984',
  '103.39.236.205:8080',
  '167.86.76.187:7497',
  '88.119.49.4:4153',
  '94.182.26.44:4153',
  '119.15.90.78:5678',
  '203.32.120.50:80',
  '58.220.69.212:26589',
  '116.203.227.24:24940',
  '173.209.38.72:12028',
  '160.0.203.99:1080',
  '121.129.47.25:1080',
  '103.35.108.145:4145',
  '95.68.225.138:1080',
  '103.70.159.153:13372',
  '119.82.226.232:7497',
  '36.67.14.195:5678',
  '184.178.172.13:15311',
  '101.51.241.126:4153',
  '110.243.6.51:9999',
  '122.152.53.25:5678',
  '161.35.229.155:61658',
  '211.174.96.81:4153',
  '110.34.166.180:4153',
  '171.39.31.66:5678',
  '221.219.97.117:1080',
  '43.128.40.142:65533',
  '103.117.108.53:4153',
  '116.103.151.218:1080',
  '37.25.127.85:1080',
  '115.209.36.18:3000',
  '104.20.75.132:80',
  '188.26.5.254:4145',
  '186.211.96.97:5678',
  '203.30.190.172:80',
  '1.179.242.33:4145',
  '82.103.116.126:4153',
  '203.113.117.49:4153',
  '78.38.108.194:1080',
  '185.169.181.27:4145',
  '87.255.13.217:8080',
  '202.40.186.157:4145',
  '113.161.175.177:5678',
  '202.150.148.218:61924',
  '36.89.80.226:5678',
  '157.185.161.100:26589',
  '221.229.252.98:9797',
  '104.20.179.187:80',
  '183.89.249.192:4153',
  '106.52.65.104:1080',
  '185.169.181.26:4145',
  '45.77.108.208:9050',
  '181.78.13.94:5678',
  '178.62.226.96:26546',
  '103.95.97.43:4153',
  '181.174.130.165:5678',
  '177.38.5.147:4153',
  '104.16.108.42:80',
  '8.219.104.50:443',
  '71.163.238.129:1236',
  '62.109.31.192:20000',
  '104.16.105.198:80',
  '101.109.170.182:4145',
  '43.157.42.203:443',
  '8.210.206.32:47161',
  '149.20.253.52:12551',
  '50.116.8.96:17477',
  '82.137.224.193:8291',
  '101.109.20.71:4145',
  '46.227.37.73:51155',
  '80.78.23.20:80',
  '119.18.152.139:4145',
  '144.126.217.189:12345',
  '128.199.27.84:45857',
  '203.80.190.162:8080',
  '66.42.63.207:13802',
  '203.32.121.161:80',
  '112.250.211.161:38801',
  '1.4.198.152:4145',
  '117.242.232.86:5678',
  '165.154.227.154:5096',
  '46.100.10.3:4153',
  '5.202.120.214:5678',
  '181.143.69.227:5678',
  '43.250.81.154:34432',
  '77.79.187.74:8080',
  '47.242.116.48:1080',
  '5.135.178.11:11624',
  '183.89.114.143:4145',
  '185.32.45.201:4153',
  '203.150.132.42:14153',
  '212.108.205.6:5678',
  '178.62.63.229:20682',
  '136.243.214.242:24940',
  '185.36.132.223:9050',
  '45.77.222.98:10312',
  '43.132.128.186:24067',
  '183.88.76.99:8080',
  '62.112.194.224:26057',
  '51.77.73.68:31979',
  '118.174.219.163:4153',
  '98.111.251.101:1585',
  '103.211.8.189:44581',
  '114.220.154.35:44844',
  '116.202.192.120:10002',
  '45.112.125.62:4145',
  '179.191.12.97:4153',
  '168.227.158.21:4145',
  '188.166.239.48:3128',
  '45.7.176.42:39867',
  '101.42.116.41:10809',
  '201.20.88.5:3128',
  '189.201.191.67:4145',
  '188.133.155.215:1256',
  '45.137.155.126:12345',
  '187.86.129.122:63253',
  '196.2.13.12:4153',
  '143.244.140.236:8444',
  '185.169.181.28:4145',
  '69.27.150.166:5678',
  '62.171.135.216:50037',
  '186.211.6.137:4145',
  '180.183.6.44:4153',
  '70.32.26.23:36546',
  '110.78.147.112:4145',
  '51.83.34.150:34214',
  '182.253.159.19:4145',
  '167.99.80.74:8080',
  '106.242.5.206:4145',
  '18.217.169.2:80',
  '196.196.160.211:80',
  '202.50.202.109:48617',
  '45.70.237.131:4145',
  '143.255.178.129:4153',
  '41.60.235.118:5678',
  '185.143.234.28:8080',
  '38.127.179.84:11537',
  '93.171.224.51:4153',
  '43.153.170.206:13220',
  '120.28.196.168:8080',
  '110.139.125.237:4145',
  '147.182.229.154:7497',
  '188.138.139.216:4145',
  '165.227.82.7:24668',
  '192.3.158.51:1080',
];
let currentProxyIndex = Math.floor(Math.random() * proxyUrls.length);

(async () => {
  puppeteerExtra.use(StealthPlugin());
  const browser = await puppeteerExtra.launch({ headless: false });
  const page = await browser.newPage();
  function getNextProxy() {
    const proxyUrl = proxyUrls[currentProxyIndex];
    currentProxyIndex = (currentProxyIndex + 1) % proxyUrls.length;
    return proxyUrl;
  }
  await page.setRequestInterception(true);
  page.on('request', (request) => {
    if (request.resourceType() === 'document' || request.resourceType() === 'script') {
      const proxyUrl = getNextProxy();
      request.continue({ proxy: { server: proxyUrl } });
    } else {
      request.continue();
    }
  });
  await page.setExtraHTTPHeaders({
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36',
    'Accept-Language': 'en-US,en;q=0.9',
  });
  await page.goto('https://cekdptonline.kpu.go.id/');
  // function connectToMySql() {
  //   const connection = mysql.createConnection({
  //     host: "localhost",
  //     user: "root",
  //     password: "",
  //     database: "dptonline",
  //   });
  //   return connection;
  // }
  function connectToMySql() {
    const connection = mysql.createConnection({
      host: "128.199.234.213",
      user: "sunan",
      password: "sunan02menang",
      database: "db",
    });
    return connection;
  }
  const connection = connectToMySql();
  connection.query("SELECT nik FROM dptonline WHERE nama IS NULL", async function (error, results) {
    if (error) {
      console.error("Error executing query:", error);
      return;
    }
    const totalData = results.length;
    let i = 0;

    for (const record of results) {
      i++;
      const { nik } = record;

      await page.goto("https://cekdptonline.kpu.go.id/");
      await page.focus("#__BVID__20");

      async function typeWithSpeed(text, speed) {
        for (const char of text) {
          await page.keyboard.type(char);
          await page.waitForTimeout(speed);
        }
      }
      await typeWithSpeed(nik, 100);
      await page.evaluate(() => {
        const buttons = document.querySelectorAll(".wizard-buttons .btn-primary");
        if (buttons.length > 1) {
          buttons[1].click();
        } else {
          console.error('The second button with class "btn-primary" was not found.');
        }
      });
      await page.waitForTimeout(3000);
      const bodyHandle = await page.$(".h-100");
      const htmlResponse = await page.evaluate((body) => body.innerHTML, bodyHandle);
      const { document } = new JSDOM(htmlResponse).window;
      try {
        const notFound = document.querySelector("h2.mb-2 b");
        if (notFound && notFound.textContent.trim() === "Data anda belum terdaftar!") {
          console.log("Tidak Terdaftar");
          const updateQuery = `UPDATE dptonline SET tps = "-", nama = "-", kecamatan = "-", kelurahan = "-" WHERE nik = ${nik}`;
          connection.query(updateQuery, (error) => {
            if (error) {
              console.error("Error updating record:", error);
              return;
            }
            console.log(`Record with NIK ${nik} updated Tidak Terdaftar!`);
          });
          continue;
        }

        const elTpsKelurahan = document.querySelectorAll(".row--right");
        const elKecamatan = document.querySelectorAll(".row--center");
        const elNama = document.querySelectorAll(".row .row-1 p");
        const tpsString = elTpsKelurahan[0].outerHTML;
        const namaString = elNama[0].outerHTML;
        const kelurahanString = elTpsKelurahan[2].outerHTML;
        const kecamatanString = elKecamatan[0].outerHTML;

        const matchTps = tpsString.match(/<p class="row--right".*?>(\d+)<\/p>/);
        const tps = matchTps ? matchTps[1] : null;

        const matchNama = namaString.match(/<p[^>]*><span>[^<]+<\/span>([^<]+)<\/p>/);
        const nama = matchNama ? matchNama[1].trim() : null;

        const matchKelurahan = kelurahanString.match(/<p class="row--right"><span>[^<]+<\/span>([^<]+)<\/p>/);
        const kelurahan = matchKelurahan ? matchKelurahan[1].trim() : null;

        const matchKecamatan = kecamatanString.match(/<p class="row--center"><span>[^<]+<\/span>([^<]+)<\/p>/);
        const kecamatan = matchKecamatan ? matchKecamatan[1].trim() : null;

        console.log(tps);
        console.log(nama);
        console.log(kelurahan);
        console.log(kecamatan);

        if (tps !== null) {
          const updateQuery = `UPDATE dptonline SET tps = '${tps}', nama = '${nama}', kecamatan = '${kecamatan}', kelurahan = '${kelurahan}' WHERE nik = ${nik}`;
          connection.query(updateQuery, (error) => {
            if (error) {
              console.error("Error updating record:", error);
              return;
            }
            console.log(`Record with NIK ${nik} updated successfully!`);
          });
        } else {
          console.log("Not Found");
        }

        if (i < totalData) {
          await page.evaluate(() => {
            const buttons = document.querySelectorAll(".wizard-buttons .btn-primary");
            buttons[0].click();
          });

          let searchInput;
          try {
            searchInput = await page.$("#__BVID__20");
            if (searchInput) {
              await searchInput.click();
            }
          } catch (error) {
            console.error("Error waiting for selector:", error);
          }

          if (searchInput) {
            for (let i = 0; i < 3; i++) {
              await searchInput.click();
            }
            await searchInput.press("Backspace");
          }
        } else {
          connection.end();
          await browser.close();
        }
      } catch (error) {
        console.log("skip");
        continue;
      }
    }
  });
})();
